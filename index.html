<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TRANSTORNO_PERSONALIDADE_SEGUNDA_FONTE</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--line:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--pri:#4f46e5;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.35rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0 6px}
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:#0b1220;border:1px solid var(--line);border-radius:10px;padding:10px}
  .info b{display:block;margin-bottom:4px;color:#cbd5e1}

  .q{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1220;margin-bottom:10px}
  .q h3{margin:0 0 8px;font-size:1rem}
  textarea{width:100%;min-height:80px;resize:vertical;border-radius:10px;border:1px solid var(--line);background:#0a0f1c;color:var(--text);padding:10px}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  label.opt{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;cursor:pointer}
  .opt input[type="radio"]{accent-color:var(--pri)}
  label.opt:has(input[type="radio"]:checked){background:var(--pri);border-color:var(--pri);color:#fff;}
  label.opt:has(input[type="radio"]:checked) span{color:#fff;font-weight:600;}

  .btn{display:inline-flex;align-items:center;gap:8px;background:var(--pri);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:10px 0;padding:10px;border-radius:8px}
  .okbox{background:#052e1a;border:1px solid #114d2a;color:#b3f7c1}
  .errbox{background:#3b0d0d;border:1px solid #5b1919;color:#ffd0d0}
  .warnbox{background:#3a2903;border:1px solid #5c4307;color:#ffe6b0}
  .legend{background:#0b1220;border:1px dashed var(--line);border-radius:10px;padding:10px;margin:6px 0 12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>TRANSTORNO_PERSONALIDADE_SEGUNDA_FONTE</h1>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>
      <div class="legend muted">Dica: responda com base em como você costuma observar o comportamento da pessoa avaliada no dia a dia.</div>

      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <div id="progress" class="muted"></div>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// ===== CONFIG =====
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_TRANSTORNO_PERSONALIDADE_SEGUNDA_FONTE" };
const CODE = "TRANSTORNO_PERSONALIDADE_SEGUNDA_FONTE";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";

// ===== HELPERS =====
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const AUTOSAVE_KEY = `${CODE}_${qs("token")||"no_token"}`;

function setBox(id, text, kind="ok"){const el=$(id);if(!el)return;el.textContent=text;el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");el.style.display="block";}
function hideBox(id){const el=$(id);if(el){el.style.display="none";el.textContent="";}}
function maskCPF(cpf){const d=onlyDigits(cpf||"");if(d.length!==11)return cpf||"";return`${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;}
function fmtDateISO(iso){if(!iso)return"";const[y,m,d]=iso.split("-");return(y&&m&&d)?`${d}/${m}/${y}`:iso;}
async function GET(url){const r=await fetch(url);if(!r.ok)throw new Error("HTTP "+r.status);return r.json();}
async function POST(url,body){const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(!r.ok)throw new Error(await r.text());return r.json();}
async function PATCH(url,body){const r=await fetch(url,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(!r.ok)throw new Error(await r.text());return r.json();}
async function sheetSearch(sheet,params){const usp=new URLSearchParams(params);return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);}
async function sheetCreate(sheet,row){return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`,{data:[row]});}
async function sheetPatchBy(sheet,column,value,data){return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,{data});}
function goPortalWithToken(){const TOKEN=qs("token");try{const u=new URL(PORTAL_URL,location.href);u.searchParams.set("token",TOKEN);location.href=u.toString();}catch(_){const sep=PORTAL_URL.includes("?")?"&":"?";location.href=PORTAL_URL+sep+"token="+encodeURIComponent(TOKEN);}}

// ===== PERGUNTAS =====
const FREQ5 = ["Nunca","Raramente","Às vezes","Frequentemente","Quase sempre"];
const YESNO = ["Sim","Não","Não sei"];

const QUESTIONS = [
  {section:"Observação Geral", text:"A pessoa demonstra dificuldade constante em manter relações estáveis e respeitosas?", options:FREQ5},
  {section:"Paranoide", text:"Mostra desconfiança frequente ou interpreta mal as intenções dos outros?", options:FREQ5},
  {section:"Paranoide", text:"Costuma guardar rancor ou reagir mal a pequenas críticas?", options:FREQ5},
  {section:"Esquizoide", text:"Prefere ficar isolado e evita contato social mesmo com familiares?", options:FREQ5},
  {section:"Esquizotípico", text:"Apresenta ideias estranhas, superstições ou fala confusa/diferente?", options:FREQ5},
  {section:"Antissocial", text:"Desrespeita regras ou causa prejuízo a outras pessoas sem remorso?", options:FREQ5},
  {section:"Antissocial", text:"Apresenta comportamento impulsivo e agressivo frequente?", options:FREQ5},
  {section:"Borderline", text:"Mostra variações bruscas de humor e dificuldade em controlar emoções?", options:FREQ5},
  {section:"Borderline", text:"Tem comportamento autodestrutivo, agressividade ou medo de abandono?", options:FREQ5},
  {section:"Histriônico", text:"Busca constantemente atenção e exagera nas reações emocionais?", options:FREQ5},
  {section:"Narcisista", text:"Demonstra arrogância ou necessidade de ser admirado o tempo todo?", options:FREQ5},
  {section:"Narcisista", text:"Tem dificuldade de reconhecer sentimentos ou necessidades dos outros?", options:FREQ5},
  {section:"Evitativo", text:"Evita situações sociais por medo de rejeição ou críticas?", options:FREQ5},
  {section:"Dependente", text:"Depende excessivamente de outras pessoas para tomar decisões?", options:FREQ5},
  {section:"OCPD", text:"É muito perfeccionista, rígido e controlador nas rotinas?", options:FREQ5},
  {section:"Impacto", text:"Os comportamentos descritos causam prejuízos significativos nas relações, trabalho ou família?", options:FREQ5}
];

const N = QUESTIONS.length;

// ===== RENDER =====
function renderQuestions(){
  const host=$("#qs");host.innerHTML="";
  QUESTIONS.forEach((q,idx)=>{
    const n=idx+1, qn=String(n).padStart(2,"0");
    const wrap=document.createElement("div");
    wrap.className="q";
    let html=`<h3>${n}. ${q.text}</h3><div class="opts">`;
    q.options.forEach((opt,i)=>{
      const id=`q${qn}_${i}`;
      html+=`<label class="opt"><input type="radio" name="q${qn}" id="${id}" value="${opt}"><span>${opt}</span></label>`;
    });
    html+="</div>";wrap.innerHTML=html;
    host.appendChild(wrap);
  });
  host.addEventListener("change",()=>{updateProg();autosaveAnswers();});
  updateProg();
}

function updateProg(){
  let filled=0;
  QUESTIONS.forEach((_,idx)=>{
    const qn=`q${String(idx+1).padStart(2,"0")}`;
    const any=document.querySelector(`input[name="${qn}"]:checked`);
    if(any)filled++;
  });
  $("#progress").textContent=`${filled}/${N} respondidas`;
}

// ===== AUTOSAVE =====
function autosaveAnswers(){
  const answers={}, qaPairs=[];
  QUESTIONS.forEach((q,idx)=>{
    const n=idx+1, qn=`q${String(n).padStart(2,"0")}`;
    const val=(document.querySelector(`input[name="${qn}"]:checked`)||{}).value||"";
    answers[qn]=val;
    qaPairs.push(`${n}. ${q.text}: ${val||"(sem resposta)"}`);
  });
  localStorage.setItem(AUTOSAVE_KEY,JSON.stringify({code:CODE,token:qs("token"),answers}));
}

function restoreAutosave(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY);if(!raw)return;
    const {answers}=JSON.parse(raw)||{};if(!answers)return;
    Object.entries(answers).forEach(([key,val])=>{
      if(val){const el=document.querySelector(`input[name="${key}"][value="${val}"]`);if(el)el.checked=true;}
    });
    updateProg();
  }catch(_){}
}
function clearAutosave(){localStorage.removeItem(AUTOSAVE_KEY);}

// ===== ESTADO =====
let patient=null, tokenRow=null, CPF="";
let startAt=Date.now();

// ===== BOOT =====
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){setBox("#alert","Link inválido (sem token).","err");return;}
    const trows=await sheetSearch(SHEETS.TOKENS,{token:TOKEN});
    if(!trows?.length)throw new Error("Token inválido ou expirado.");
    tokenRow=trows[0];
    const disabled=String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired=tokenRow.expires_at&&(Date.parse(tokenRow.expires_at)<Date.now());
    if(disabled||expired)throw new Error("Token desativado/expirado.");
    CPF=onlyDigits(tokenRow.cpf||"");if(!CPF)throw new Error("Token sem CPF.");
    const prows=await sheetSearch(SHEETS.PATIENTS,{cpf:CPF});
    if(!prows?.length)throw new Error("Paciente não encontrado.");
    patient=prows[0];
    renderPatientInfo();renderQuestions();
    $("#pacInfo").style.display="grid";$("#form").style.display="block";hideBox("#alert");restoreAutosave();
  }catch(err){console.error(err);setBox("#alert",err.message,"err");}
})();

function renderPatientInfo(){
  const g=$("#pacInfo");g.innerHTML="";
  const info=[["Nome",patient.nome||"-"],["CPF",maskCPF(patient.cpf)],["Nascimento",fmtDateISO(patient.data_nascimento)],["E-mail",patient.email||"-"],["WhatsApp",patient.whatsapp||"-"]];
  for(const[k,v]of info){const d=document.createElement("div");d.className="info";d.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;g.appendChild(d);}
}

// ===== SUBMIT =====
let sending=false;
$("#form").addEventListener("submit",async e=>{
  e.preventDefault();if(sending)return;sending=true;hideBox("#msg");
  const btn=$("#btnSubmit");const original=btn.textContent;btn.disabled=true;btn.textContent="Enviando…";
  try{
    const answers={},qaPairs=[];let answered=0;
    QUESTIONS.forEach((q,idx)=>{
      const n=idx+1,qn=`q${String(n).padStart(2,"0")}`;
      const val=(document.querySelector(`input[name="${qn}"]:checked`)||{}).value||"";
      answers[qn]=val;if(val)answered++;
      qaPairs.push(`${n}. ${q.text}: ${val||"(sem resposta)"}`);
    });
    const categoria=qaPairs.join(" | ");
    const row={
      result_id:`${patient.cpf}_${CODE}_${Date.now()}`,
      token:qs("token"),cpf:patient.cpf,code:CODE,
      source:"familiares/amigos",
      submitted_at:new Date().toISOString(),
      total:answered,categoria,
      metrics:JSON.stringify({questions:QUESTIONS,answers,answeredCount:answered,duration_sec:Math.round((Date.now()-startAt)/1000)})
    };
    await sheetCreate(SHEETS.SCORES,row);
    clearAutosave();
    setBox("#msg","Formulário enviado com sucesso. Retornando ao portal…","ok");
    setTimeout(goPortalWithToken,1200);
  }catch(err){
    console.error(err);
    setBox("#msg",err.message||"Falha ao enviar. Tente novamente.","err");
    sending=false;btn.disabled=false;btn.textContent=original;
  }
});
</script>
</body>
</html>
